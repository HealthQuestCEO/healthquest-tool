<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthQuest Research Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #E8F5F9 0%, #F1F9E8 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #00A3E0;
            margin: 0 0 10px 0;
        }
        
        .header p {
            color: #666;
            margin: 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            color: #00A3E0;
        }
        
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .chart-container h2 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 20px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        button {
            background: linear-gradient(135deg, #00A3E0 0%, #0077B3 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: opacity 0.3s;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button.secondary {
            background: linear-gradient(135deg, #7AC943 0%, #5FA32E 100%);
        }
        
        .file-upload {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            text-align: center;
            border: 3px dashed #00A3E0;
        }
        
        .file-upload input[type="file"] {
            display: none;
        }
        
        .file-upload label {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #00A3E0 0%, #0077B3 100%);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .file-upload label:hover {
            opacity: 0.9;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        table th {
            background: #f5f5f5;
            font-weight: bold;
            color: #333;
        }
        
        table tr:hover {
            background: #f9f9f9;
        }
        
        .insight-box {
            background: #E8F5F9;
            border-left: 4px solid #00A3E0;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
        }
        
        .insight-box strong {
            color: #00A3E0;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä HealthQuest Clinical Insights Dashboard</h1>
            <p>De-identified Research Data Analysis - HIPAA Compliant</p>
        </div>

        <div class="file-upload">
            <h3>üìÅ Upload Research Data Files</h3>
            <p style="color: #666; margin: 10px 0 20px 0;">
                Select one or more JSON files exported from the wellness tool
            </p>
            <input type="file" id="fileInput" accept=".json" multiple onchange="loadFiles(event)">
            <label for="fileInput">üì• Choose Files</label>
            <p style="color: #999; font-size: 12px; margin-top: 15px;">
                Accepts: healthquest-research-*.json files
            </p>
        </div>

        <div id="noData" class="no-data">
            <p style="font-size: 18px;">üìä No data loaded yet</p>
            <p style="color: #666;">Upload JSON files to view analytics</p>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Assessments</h3>
                    <div class="value" id="totalAssessments">0</div>
                </div>
                <div class="stat-card">
                    <h3>Date Range</h3>
                    <div class="value" style="font-size: 18px; color: #7AC943;" id="dateRange">-</div>
                </div>
                <div class="stat-card">
                    <h3>Top Barrier</h3>
                    <div class="value" style="font-size: 18px; color: #FF6B6B;" id="topBarrier">-</div>
                </div>
                <div class="stat-card">
                    <h3>Alignment Rate</h3>
                    <div class="value" style="font-size: 24px; color: #F39C12;" id="alignmentRate">0%</div>
                </div>
            </div>

            <div class="button-group">
                <button onclick="exportCSV()">üì• Export to CSV</button>
                <button class="secondary" onclick="exportSummary()">üìÑ Export Summary Report</button>
                <button class="secondary" onclick="clearData()">üîÑ Clear & Reload</button>
            </div>

            <div class="chart-container">
                <h2>Top Barriers (Data-Driven Assessment)</h2>
                <canvas id="barrierChart"></canvas>
                <div class="insight-box" id="barrierInsight"></div>
            </div>

            <div class="chart-container">
                <h2>Three-Way Alignment Analysis</h2>
                <canvas id="alignmentChart"></canvas>
                <div class="insight-box" id="alignmentInsight"></div>
            </div>

            <div class="chart-container">
                <h2>Age Group Patterns</h2>
                <div id="agePatterns"></div>
            </div>

            <div class="chart-container">
                <h2>Client vs Provider Assessment</h2>
                <canvas id="comparisonChart"></canvas>
                <div class="insight-box" id="comparisonInsight"></div>
            </div>

            <div class="chart-container">
                <h2>Most Selected Goals</h2>
                <canvas id="goalsChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let charts = {};

        function loadFiles(event) {
            const files = event.target.files;
            allData = [];

            let loadedCount = 0;
            const totalFiles = files.length;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        allData.push(data);
                        loadedCount++;

                        if (loadedCount === totalFiles) {
                            processData();
                        }
                    } catch (error) {
                        console.error('Error parsing file:', file.name, error);
                        loadedCount++;
                        if (loadedCount === totalFiles) {
                            processData();
                        }
                    }
                };

                reader.readAsText(file);
            }
        }

        function processData() {
            if (allData.length === 0) {
                alert('No valid data files loaded!');
                return;
            }

            // Show dashboard, hide no-data message
            document.getElementById('noData').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            // Update stats
            updateStats();

            // Create visualizations
            createBarrierChart();
            createAlignmentChart();
            createAgePatterns();
            createComparisonChart();
            createGoalsChart();
        }

        function updateStats() {
            // Total assessments
            document.getElementById('totalAssessments').textContent = allData.length;

            // Date range
            const timestamps = allData.map(d => d.timestamp).sort();
            const minDate = timestamps[0];
            const maxDate = timestamps[timestamps.length - 1];
            document.getElementById('dateRange').textContent = minDate === maxDate ? minDate : `${minDate} - ${maxDate}`;

            // Top barrier
            const barrierCounts = {};
            allData.forEach(d => {
                barrierCounts[d.topBarrier] = (barrierCounts[d.topBarrier] || 0) + 1;
            });
            const topBarrier = Object.keys(barrierCounts).reduce((a, b) => 
                barrierCounts[a] > barrierCounts[b] ? a : b
            );
            const topBarrierShort = topBarrier.split(' ').slice(0, 2).join(' ');
            document.getElementById('topBarrier').textContent = topBarrierShort;

            // Alignment rate (strong + moderate)
            const alignmentCounts = {
                'strong-alignment': 0,
                'moderate-alignment': 0,
                'significant-discrepancy': 0
            };
            allData.forEach(d => {
                alignmentCounts[d.alignmentType] = (alignmentCounts[d.alignmentType] || 0) + 1;
            });
            const alignmentRate = Math.round(
                ((alignmentCounts['strong-alignment'] + alignmentCounts['moderate-alignment']) / allData.length) * 100
            );
            document.getElementById('alignmentRate').textContent = alignmentRate + '%';
        }

        function createBarrierChart() {
            const barrierCounts = {};
            allData.forEach(d => {
                barrierCounts[d.topBarrier] = (barrierCounts[d.topBarrier] || 0) + 1;
            });

            const sortedBarriers = Object.entries(barrierCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            const labels = sortedBarriers.map(b => b[0]);
            const data = sortedBarriers.map(b => b[1]);
            const percentages = sortedBarriers.map(b => Math.round((b[1] / allData.length) * 100));

            if (charts.barrierChart) charts.barrierChart.destroy();

            const ctx = document.getElementById('barrierChart').getContext('2d');
            charts.barrierChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frequency',
                        data: data,
                        backgroundColor: '#00A3E0',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} assessments (${percentages[context.dataIndex]}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });

            // Add insight
            const topBarrier = sortedBarriers[0];
            const topPercent = Math.round((topBarrier[1] / allData.length) * 100);
            document.getElementById('barrierInsight').innerHTML = 
                `<strong>Key Insight:</strong> ${topBarrier[0]} is the most common barrier, appearing in ${topPercent}% of assessments.`;
        }

        function createAlignmentChart() {
            const alignmentCounts = {
                'strong-alignment': 0,
                'moderate-alignment': 0,
                'significant-discrepancy': 0
            };

            allData.forEach(d => {
                alignmentCounts[d.alignmentType] = (alignmentCounts[d.alignmentType] || 0) + 1;
            });

            if (charts.alignmentChart) charts.alignmentChart.destroy();

            const ctx = document.getElementById('alignmentChart').getContext('2d');
            charts.alignmentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Strong Alignment', 'Moderate Alignment', 'Significant Discrepancy'],
                    datasets: [{
                        data: [
                            alignmentCounts['strong-alignment'],
                            alignmentCounts['moderate-alignment'],
                            alignmentCounts['significant-discrepancy']
                        ],
                        backgroundColor: ['#7AC943', '#F39C12', '#FF6B6B'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Add insight
            const strongPercent = Math.round((alignmentCounts['strong-alignment'] / allData.length) * 100);
            const discrepancyPercent = Math.round((alignmentCounts['significant-discrepancy'] / allData.length) * 100);
            
            let insightText = '';
            if (strongPercent > 30) {
                insightText = `<strong>Positive Finding:</strong> ${strongPercent}% of clients show strong self-awareness (all three perspectives align).`;
            } else if (discrepancyPercent > 40) {
                insightText = `<strong>Clinical Note:</strong> ${discrepancyPercent}% of cases show significant discrepancy between perspectives. Consider enhanced psychoeducation.`;
            } else {
                insightText = `<strong>Observation:</strong> Most clients (${100 - discrepancyPercent}%) demonstrate moderate to strong alignment in barrier identification.`;
            }
            
            document.getElementById('alignmentInsight').innerHTML = insightText;
        }

        function createAgePatterns() {
            const ageGroups = {
                '5-8': {},
                '9-12': {},
                '13-18': {}
            };

            allData.forEach(d => {
                const age = d.ageRange;
                const barrier = d.topBarrier;
                if (ageGroups[age]) {
                    ageGroups[age][barrier] = (ageGroups[age][barrier] || 0) + 1;
                }
            });

            let html = '<table>';
            html += '<tr><th>Age Group</th><th>Most Common Barrier</th><th>Count</th><th>%</th></tr>';

            Object.keys(ageGroups).forEach(age => {
                const barriers = ageGroups[age];
                if (Object.keys(barriers).length === 0) {
                    html += `<tr><td>${age}</td><td colspan="3" style="color: #999;">No data</td></tr>`;
                } else {
                    const topBarrier = Object.keys(barriers).reduce((a, b) => 
                        barriers[a] > barriers[b] ? a : b
                    );
                    const count = barriers[topBarrier];
                    const total = Object.values(barriers).reduce((a, b) => a + b, 0);
                    const percent = Math.round((count / total) * 100);
                    html += `<tr><td><strong>${age}</strong></td><td>${topBarrier}</td><td>${count}</td><td>${percent}%</td></tr>`;
                }
            });

            html += '</table>';
            document.getElementById('agePatterns').innerHTML = html;
        }

        function createComparisonChart() {
            // Count how often client and provider perspectives match
            let clientProviderMatch = 0;
            let clientDataMatch = 0;
            let providerDataMatch = 0;

            allData.forEach(d => {
                const client = d.clientPerceived.toLowerCase();
                const provider = d.providerAssessed.toLowerCase();
                const data = d.topBarrier.toLowerCase();

                if (client.includes(provider.split('-')[0]) || provider.includes(client.split('-')[0])) {
                    clientProviderMatch++;
                }
                if (data.includes(client.split('-')[0])) {
                    clientDataMatch++;
                }
                if (data.includes(provider.split('-')[0])) {
                    providerDataMatch++;
                }
            });

            const clientProviderPercent = Math.round((clientProviderMatch / allData.length) * 100);
            const clientDataPercent = Math.round((clientDataMatch / allData.length) * 100);
            const providerDataPercent = Math.round((providerDataMatch / allData.length) * 100);

            if (charts.comparisonChart) charts.comparisonChart.destroy();

            const ctx = document.getElementById('comparisonChart').getContext('2d');
            charts.comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Client ‚Üî Provider', 'Client ‚Üî Data', 'Provider ‚Üî Data'],
                    datasets: [{
                        label: 'Agreement Rate (%)',
                        data: [clientProviderPercent, clientDataPercent, providerDataPercent],
                        backgroundColor: ['#9B59B6', '#F39C12', '#00A3E0'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Add insight
            const highest = Math.max(clientProviderPercent, clientDataPercent, providerDataPercent);
            let perspective = '';
            if (highest === providerDataPercent) {
                perspective = 'Provider assessments closely align with data-driven results';
            } else if (highest === clientDataPercent) {
                perspective = 'Clients demonstrate good self-awareness of their barriers';
            } else {
                perspective = 'Client and provider perspectives align well';
            }

            document.getElementById('comparisonInsight').innerHTML = 
                `<strong>Key Finding:</strong> ${perspective} (${highest}% agreement).`;
        }

        function createGoalsChart() {
            const goalCounts = {};
            
            allData.forEach(d => {
                d.goalsSelected.forEach(goal => {
                    goalCounts[goal] = (goalCounts[goal] || 0) + 1;
                });
            });

            const sortedGoals = Object.entries(goalCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);

            const labels = sortedGoals.map(g => {
                // Format goal names
                return g[0].split('-').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
            });
            const data = sortedGoals.map(g => g[1]);

            if (charts.goalsChart) charts.goalsChart.destroy();

            const ctx = document.getElementById('goalsChart').getContext('2d');
            charts.goalsChart = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Times Selected',
                        data: data,
                        backgroundColor: '#7AC943',
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        function exportCSV() {
            if (allData.length === 0) {
                alert('No data to export!');
                return;
            }

            // Create CSV header
            let csv = 'ID,Timestamp,Age Range,Top Barrier,Client Perceived,Provider Assessed,Alignment Type,Mental Health,Psychological Weight,Nutrition,Physical Activity,Hope Resilience,Mindfulness,Intuitive Eating,Anti-Bullying,Goals\n';

            // Add data rows
            allData.forEach(d => {
                const goals = d.goalsSelected.join(';');
                csv += `${d.id},${d.timestamp},${d.ageRange},${d.topBarrier},${d.clientPerceived},${d.providerAssessed},${d.alignmentType},${d.barriers.mentalHealth},${d.barriers.psychologicalWeight},${d.barriers.nutrition},${d.barriers.physicalActivity},${d.barriers.hopeResilience},${d.barriers.mindfulness},${d.barriers.intuitiveEating},${d.barriers.antiBullying},"${goals}"\n`;
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `healthquest-research-data-${Date.now()}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function exportSummary() {
            if (allData.length === 0) {
                alert('No data to export!');
                return;
            }

            // Generate summary report
            let summary = 'HealthQuest Clinical Research Summary Report\n';
            summary += '='.repeat(50) + '\n\n';
            summary += `Generated: ${new Date().toLocaleDateString()}\n`;
            summary += `Total Assessments: ${allData.length}\n\n`;

            // Top barriers
            const barrierCounts = {};
            allData.forEach(d => {
                barrierCounts[d.topBarrier] = (barrierCounts[d.topBarrier] || 0) + 1;
            });
            const sortedBarriers = Object.entries(barrierCounts).sort((a, b) => b[1] - a[1]);
            
            summary += 'TOP BARRIERS:\n';
            sortedBarriers.forEach((b, idx) => {
                const percent = Math.round((b[1] / allData.length) * 100);
                summary += `${idx + 1}. ${b[0]}: ${b[1]} (${percent}%)\n`;
            });

            // Alignment
            const alignmentCounts = {
                'strong-alignment': 0,
                'moderate-alignment': 0,
                'significant-discrepancy': 0
            };
            allData.forEach(d => {
                alignmentCounts[d.alignmentType] = (alignmentCounts[d.alignmentType] || 0) + 1;
            });

            summary += '\nALIGNMENT ANALYSIS:\n';
            summary += `Strong Alignment: ${alignmentCounts['strong-alignment']} (${Math.round((alignmentCounts['strong-alignment']/allData.length)*100)}%)\n`;
            summary += `Moderate Alignment: ${alignmentCounts['moderate-alignment']} (${Math.round((alignmentCounts['moderate-alignment']/allData.length)*100)}%)\n`;
            summary += `Significant Discrepancy: ${alignmentCounts['significant-discrepancy']} (${Math.round((alignmentCounts['significant-discrepancy']/allData.length)*100)}%)\n`;

            // Download
            const blob = new Blob([summary], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `healthquest-summary-${Date.now()}.txt`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function clearData() {
            if (confirm('Clear all loaded data and start fresh?')) {
                allData = [];
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('noData').style.display = 'block';
                document.getElementById('fileInput').value = '';
            }
        }
    </script>
</body>
</html>
